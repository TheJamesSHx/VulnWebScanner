"""OWASP A03 - Injection Scanner (SQL, Command, etc.)"""

import asyncio
from typing import Dict, Any
from modules.base_module import BaseModule

class InjectionScanner(BaseModule):
    """Scanner for injection vulnerabilities"""
    
    async def scan(self, target: Dict[str, Any]) -> Dict[str, Any]:
        """Execute injection vulnerability scanning"""
        url = target["url"]
        
        self.log_info(f"Starting injection scan for {url}")
        
        results = {
            "target": url,
            "sql_injection": {},
            "command_injection": {},
            "vulnerabilities": []
        }
        
        # SQL Injection testing
        if self.tool_manager.is_tool_available("sqlmap"):
            self.log_info("Running sqlmap...")
            sqlmap_result = await self._run_sqlmap(url)
            results["sql_injection"] = sqlmap_result
            
            if sqlmap_result.get("vulnerable"):
                results["vulnerabilities"].append({
                    "type": "SQL Injection",
                    "severity": "CRITICAL",
                    "details": sqlmap_result
                })
        
        # Command injection with nuclei
        if self.tool_manager.is_tool_available("nuclei"):
            self.log_info("Running nuclei for injection templates...")
            nuclei_result = await self._run_nuclei_injection(url)
            
            if nuclei_result.get("findings"):
                results["vulnerabilities"].extend(nuclei_result["findings"])
        
        self.log_info(f"Injection scan complete: {len(results['vulnerabilities'])} issues found")
        
        return results
    
    async def _run_sqlmap(self, url: str) -> Dict:
        """Run sqlmap for SQL injection testing"""
        # Safer sqlmap configuration
        args = [
            "--batch",  # Never ask for user input
            "--random-agent",  # Random user agent
            "--level=2",  # Test level (1-5)
            "--risk=1",  # Risk level (1-3) - start conservative
            "--threads=4",  # 4 threads
            "--timeout=30",  # 30 second timeout
            "--retries=2",  # Max 2 retries
            "--technique=BEUST",  # All techniques
            "--smart",  # Heuristic testing
            "--crawl=2",  # Crawl depth
        ]
        
        result = await self.tool_manager.run_tool("sqlmap", url, args)
        
        vulnerable = False
        findings = []
        
        if result.get("success") and result.get("stdout"):
            output = result["stdout"].lower()
            
            # Check for vulnerability indicators
            if "vulnerable" in output or "injectable" in output:
                vulnerable = True
                
            # Parse output for specific findings
            for line in result["stdout"].split("\n"):
                if "Parameter:" in line or "Type:" in line or "Injectable" in line:
                    findings.append(line.strip())
        
        return {
            "vulnerable": vulnerable,
            "findings": findings,
            "raw_output": result.get("stdout", "")[:2000]  # Limit output size
        }
    
    async def _run_nuclei_injection(self, url: str) -> Dict:
        """Run nuclei with injection templates"""
        args = [
            "-t", "cves/,vulnerabilities/injection/",  # Injection templates
            "-severity", "critical,high,medium",
            "-silent",
            "-json",  # JSON output
            "-rate-limit", "150",
        ]
        
        result = await self.tool_manager.run_tool("nuclei", url, args)
        
        findings = []
        if result.get("success") and result.get("stdout"):
            # Parse JSON output
            for line in result["stdout"].split("\n"):
                if line.strip() and "info" in line.lower():
                    findings.append({
                        "type": "Injection",
                        "source": "nuclei",
                        "details": line.strip()
                    })
        
        return {"findings": findings}
