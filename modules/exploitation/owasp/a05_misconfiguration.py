"""OWASP A05 - Security Misconfiguration Scanner"""

import asyncio
from typing import Dict, Any
from modules.base_module import BaseModule

class MisconfigurationScanner(BaseModule):
    """Scanner for security misconfigurations"""
    
    async def scan(self, target: Dict[str, Any]) -> Dict[str, Any]:
        """Execute misconfiguration scanning"""
        url = target["url"]
        
        self.log_info(f"Starting misconfiguration scan for {url}")
        
        results = {
            "target": url,
            "vulnerabilities": [],
            "misconfigurations": []
        }
        
        # Run nuclei with misconfiguration templates
        if self.tool_manager.is_tool_available("nuclei"):
            self.log_info("Running nuclei misconfiguration templates...")
            nuclei_result = await self._run_nuclei_misconfig(url)
            
            if nuclei_result.get("vulnerabilities"):
                results["vulnerabilities"].extend(nuclei_result["vulnerabilities"])
        
        # Check for common misconfigurations
        if self.tool_manager.is_tool_available("nikto"):
            self.log_info("Running nikto for misconfigurations...")
            nikto_result = await self._run_nikto(url)
            
            if nikto_result.get("findings"):
                results["misconfigurations"].extend(nikto_result["findings"])
        
        self.log_info(f"Misconfiguration scan complete: {len(results['vulnerabilities'])} issues found")
        
        return results
    
    async def _run_nuclei_misconfig(self, url: str) -> Dict:
        """Run nuclei with misconfiguration templates"""
        args = [
            "-t", "misconfiguration/,exposures/,misconfigurations/",
            "-severity", "critical,high,medium",
            "-silent",
            "-rate-limit", "150",
        ]
        
        result = await self.tool_manager.run_tool("nuclei", url, args)
        
        vulnerabilities = []
        if result.get("success") and result.get("stdout"):
            for line in result["stdout"].split("\n"):
                if line.strip():
                    vulnerabilities.append({
                        "type": "Misconfiguration",
                        "severity": "MEDIUM",
                        "tool": "nuclei",
                        "details": line.strip()
                    })
        
        return {"vulnerabilities": vulnerabilities}
    
    async def _run_nikto(self, url: str) -> Dict:
        """Run nikto for misconfigurations"""
        result = await self.tool_manager.run_tool("nikto", url, ["-nointeractive"])
        
        findings = []
        if result.get("success") and result.get("stdout"):
            for line in result["stdout"].split("\n"):
                if "+" in line and any(word in line.lower() for word in ["config", "disclosure", "exposed"]):
                    findings.append(line.strip())
        
        return {"findings": findings}
