"""OWASP A03 - XSS (Cross-Site Scripting) Scanner"""

import asyncio
from typing import Dict, Any
from modules.base_module import BaseModule

class XSSScanner(BaseModule):
    """Scanner for XSS vulnerabilities"""
    
    async def scan(self, target: Dict[str, Any]) -> Dict[str, Any]:
        """Execute XSS vulnerability scanning"""
        url = target["url"]
        
        self.log_info(f"Starting XSS scan for {url}")
        
        results = {
            "target": url,
            "vulnerabilities": [],
            "tested_vectors": 0
        }
        
        # Try dalfox first (modern, fast)
        if self.tool_manager.is_tool_available("dalfox"):
            self.log_info("Running dalfox...")
            dalfox_result = await self._run_dalfox(url)
            
            if dalfox_result.get("vulnerabilities"):
                results["vulnerabilities"].extend(dalfox_result["vulnerabilities"])
        
        # XSStrike as alternative
        elif self.tool_manager.is_tool_available("xsstrike"):
            self.log_info("Running XSStrike...")
            xsstrike_result = await self._run_xsstrike(url)
            
            if xsstrike_result.get("vulnerabilities"):
                results["vulnerabilities"].extend(xsstrike_result["vulnerabilities"])
        
        # Also run nuclei XSS templates
        if self.tool_manager.is_tool_available("nuclei"):
            self.log_info("Running nuclei XSS templates...")
            nuclei_result = await self._run_nuclei_xss(url)
            
            if nuclei_result.get("vulnerabilities"):
                results["vulnerabilities"].extend(nuclei_result["vulnerabilities"])
        
        self.log_info(f"XSS scan complete: {len(results['vulnerabilities'])} issues found")
        
        return results
    
    async def _run_dalfox(self, url: str) -> Dict:
        """Run dalfox XSS scanner"""
        args = [
            "--skip-bav",  # Skip BAV(Basic Another Vulnerability) analysis
            "--only-poc",  # Only show POC code
            "--silence",  # Minimal output
            "--timeout", "30",
            "--worker", "50",
        ]
        
        result = await self.tool_manager.run_tool("dalfox", url, args)
        
        vulnerabilities = []
        if result.get("success") and result.get("stdout"):
            output = result["stdout"]
            
            # Parse dalfox output
            for line in output.split("\n"):
                if "POC" in line or "XSS" in line or "Vulnerable" in line:
                    vulnerabilities.append({
                        "type": "XSS",
                        "severity": "HIGH",
                        "tool": "dalfox",
                        "details": line.strip()
                    })
        
        return {"vulnerabilities": vulnerabilities}
    
    async def _run_xsstrike(self, url: str) -> Dict:
        """Run XSStrike scanner"""
        args = [
            "--crawl",  # Crawl and test
            "--timeout", "30",
        ]
        
        result = await self.tool_manager.run_tool("xsstrike", url, args)
        
        vulnerabilities = []
        if result.get("success") and result.get("stdout"):
            output = result["stdout"]
            
            # Parse XSStrike output
            if "vulnerable" in output.lower():
                for line in output.split("\n"):
                    if "xss" in line.lower() or "payload" in line.lower():
                        vulnerabilities.append({
                            "type": "XSS",
                            "severity": "HIGH",
                            "tool": "xsstrike",
                            "details": line.strip()
                        })
        
        return {"vulnerabilities": vulnerabilities}
    
    async def _run_nuclei_xss(self, url: str) -> Dict:
        """Run nuclei with XSS templates"""
        args = [
            "-t", "vulnerabilities/xss/,cves/",
            "-severity", "high,critical",
            "-silent",
            "-rate-limit", "100",
        ]
        
        result = await self.tool_manager.run_tool("nuclei", url, args)
        
        vulnerabilities = []
        if result.get("success") and result.get("stdout"):
            for line in result["stdout"].split("\n"):
                if "xss" in line.lower():
                    vulnerabilities.append({
                        "type": "XSS",
                        "severity": "HIGH",
                        "tool": "nuclei",
                        "details": line.strip()
                    })
        
        return {"vulnerabilities": vulnerabilities}
