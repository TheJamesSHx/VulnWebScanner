"""OWASP A07 - Authentication Failures Scanner"""

import asyncio
from typing import Dict, Any
from modules.base_module import BaseModule

class AuthFailureScanner(BaseModule):
    """Scanner for authentication and session management vulnerabilities"""
    
    async def scan(self, target: Dict[str, Any]) -> Dict[str, Any]:
        """Execute authentication failure scanning"""
        url = target["url"]
        
        self.log_info(f"Starting authentication scan for {url}")
        
        results = {
            "target": url,
            "vulnerabilities": [],
            "weak_auth": []
        }
        
        # Run nuclei with authentication templates
        if self.tool_manager.is_tool_available("nuclei"):
            self.log_info("Running nuclei authentication templates...")
            nuclei_result = await self._run_nuclei_auth(url)
            
            if nuclei_result.get("vulnerabilities"):
                results["vulnerabilities"].extend(nuclei_result["vulnerabilities"])
        
        self.log_info(f"Authentication scan complete: {len(results['vulnerabilities'])} issues found")
        
        return results
    
    async def _run_nuclei_auth(self, url: str) -> Dict:
        """Run nuclei with authentication templates"""
        args = [
            "-t", "vulnerabilities/auth-bypass/,default-logins/",
            "-severity", "critical,high",
            "-silent",
            "-rate-limit", "150",
        ]
        
        result = await self.tool_manager.run_tool("nuclei", url, args)
        
        vulnerabilities = []
        if result.get("success") and result.get("stdout"):
            for line in result["stdout"].split("\n"):
                if line.strip():
                    vulnerabilities.append({
                        "type": "Authentication Failure",
                        "severity": "HIGH",
                        "tool": "nuclei",
                        "details": line.strip()
                    })
        
        return {"vulnerabilities": vulnerabilities}
